name: Deploy to GitHub Pages

on:
  # Manual trigger from GitHub Actions UI
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Number of days to look back for patches'
        required: false
        default: '14'
        type: string
      max_patches:
        description: 'Maximum number of patch series to analyze'
        required: false
        default: '10'
        type: string

# Set permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Ensure only one deployment runs at a time
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-pages-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-pages-
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run bulk analysis with live data
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "ğŸ” Fetching and analyzing latest Rust patches..."
        python rust_patch_monitor.py analyze-bulk \
          --days ${{ inputs.days_back || '14' }} \
          --max-patches ${{ inputs.max_patches || '10' }} \
          --claude-key "$ANTHROPIC_API_KEY" \
          --no-comments \
          --summary-report
        
        echo "âœ… Analysis complete. Generated web UI data:"
        ls -la web-ui/src/data/patches.json
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "20"
        cache: 'npm'
        cache-dependency-path: web-ui/package-lock.json
    
    - name: Install web UI dependencies
      working-directory: web-ui
      run: npm ci
    
    - name: Build web UI with fresh data
      working-directory: web-ui
      run: |
        echo "ğŸ—ï¸ Building static site with fresh patch analysis..."
        npm run build
        
        echo "ğŸ“Š Build output:"
        ls -la dist/
        
        echo "ğŸ“„ Generated HTML size:"
        du -h dist/index.html
    
    - name: Setup GitHub Pages
      uses: actions/configure-pages@v4
    
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: web-ui/dist
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Summary
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸ“ Site URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ“Š Analyzed ${{ inputs.max_patches || '10' }} patch series from last ${{ inputs.days_back || '14' }} days"
        echo "ğŸ•’ Generated at: $(date)"